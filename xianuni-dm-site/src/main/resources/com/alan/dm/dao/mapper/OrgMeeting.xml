<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alan.dm.dao.mapper.OrgMeetingMapper">

    <sql id="A_TABLE">tb_org_meeting</sql>
    <sql id="PERSON_TABLE">tb_person</sql>
    <sql id="ORG_TABLE">tb_orgnization</sql>

    <resultMap id="PERSON_INFO" type="com.alan.dm.entity.Person">
        <id property="id" column="personId"/>
        <result property="name" column="personName"/>
        <result property="number" column="personNumber"/>
        <result property="type" column="personType"/>
    </resultMap>

    <resultMap id="A_INFO" type="com.alan.dm.entity.OrgMeeting">
        <id property="id" column="id" />
        <association property="compere" column="personId" javaType="com.alan.dm.entity.Person" resultMap="PERSON_INFO"/>
    </resultMap>

    <insert id="insert" parameterType="com.alan.dm.entity.OrgMeeting" useGeneratedKeys="true"
            keyColumn="id" keyProperty="orgMeeting.id">
        INSERT INTO <include refid="A_TABLE"/>
        (activity,orgId,meetingType,startTime,endTime,location,theme,compere,
        shouldNumberOfPeople,realNumberOfPeople,content,filePath,attendancePeople,
        absencePeople,createTime)
        VALUES(#{orgMeeting.activity},#{orgMeeting.orgnization.id},#{orgMeeting.meetingType},
        #{orgMeeting.startTime},#{orgMeeting.endTime},#{orgMeeting.location},#{orgMeeting.theme},
        #{orgMeeting.compere.id},#{orgMeeting.shouldNumberOfPeople},#{orgMeeting.realNumberOfPeople},
        #{orgMeeting.content},#{orgMeeting.filePath},#{orgMeeting.attendancePeople},
        #{orgMeeting.absencePeople},#{orgMeeting.createTime})
    </insert>

    <update id="update" parameterType="com.alan.dm.entity.OrgMeeting">
        update
        <include refid="A_TABLE" />
        <set>
            <if test="orgMeeting.activity != 0">activity=#{orgMeeting.activity},</if>
            <if test="orgMeeting.orgId != 0">orgId=#{orgMeeting.orgnization.id},</if>
            <if test="orgMeeting.meetingType != 0">meetingType=#{orgMeeting.meetingType},</if>
            <if test="orgMeeting.startTime != null">startTime=#{orgMeeting.startTime},</if>
            <if test="orgMeeting.endTime != null">endTime=#{orgMeeting.endTime},</if>
            <if test="orgMeeting.location != null">location=#{orgMeeting.location},</if>
            <if test="orgMeeting.theme != null">theme=#{orgMeeting.theme},</if>
            <if test="orgMeeting.compere != null">compere=#{orgMeeting.compere.id},</if>
            <if test="orgMeeting.shouldNumberOfPeople != 0">shouldNumberOfPeople=#{orgMeeting.shouldNumberOfPeople},</if>
            <if test="orgMeeting.realNumberOfPeople != 0">realNumberOfPeople=#{orgMeeting.realNumberOfPeople},</if>
            <if test="orgMeeting.content != null">content=#{orgMeeting.content},</if>
            <if test="orgMeeting.filePath != null">filePath=#{orgMeeting.filePath},</if>
            <if test="orgMeeting.attendancePeople != null">attendancePeople=#{orgMeeting.attendancePeople},</if>
            <if test="orgMeeting.absencePeople != null">absencePeople=#{orgMeeting.absencePeople},</if>
            <if test="orgMeeting.updateTime != null">updateTime=#{orgMeeting.updateTime}</if>
        </set>
        where id=#{orgMeeting.id}
    </update>

    <select id="getByCondition" resultMap="A_INFO">
        SELECT
        A.id,
        A.activity,
        A.meetingType,
        A.startTime,
        A.endTime,
        A.location,
        A.theme,
        A.shouldNumberOfPeople,
        A.realNumberOfPeople,
        A.content,
        A.attendancePeople,
        A.absencePeople,
        A.filePath,
        A.personId as personId,
        P.name as personName,
        P.number as personNumber,
        P.type as personType

        FROM  <include refid="A_TABLE" /> A
        LEFT JOIN <include refid="PERSON_TABLE"/> P ON A.personId=P.id
        <where>
            <if test="condition.organizationId != null">A.orgId=#{condition.organizationId}</if>
            <if test="condition.activityType != null">AND A.activityType=#{condition.activityType}</if>
            <if test="condition.theme != null">
                <bind name="pattern" value="'%' +condition.theme+ '%'" />
                AND A.theme LIKE #{pattern}
            </if>
        </where>
        ORDER BY meetingId DESC
        <if test="page!=null">
            LIMIT #{page.current}, #{page.size}
        </if>
    </select>

    <select id="countByCondition" resultType="Integer">
        SELECT count(*)
        FROM  <include refid="A_TABLE" /> A
        LEFT JOIN <include refid="PERSON_TABLE"/> P ON A.personId=P.id
        <where>
            <if test="condition.organizationId != null">A.orgId=#{condition.organizationId}</if>
            <if test="condition.activityType != null">AND A.activityType=#{condition.activityType}</if>
            <if test="condition.theme != null">
                <bind name="pattern" value="'%' +condition.theme+ '%'" />
                AND A.theme LIKE #{pattern}
            </if>
        </where>
    </select>

    <delete id="delete" parameterType="com.alan.dm.entity.OrgMeeting">
        DELETE
        FROM <include refid="A_TABLE"/>
        WHERE id=#{id}
    </delete>

</mapper>